#!/usr/bin/env ruby

def run(cmd)
  exit($?.exitstatus) unless system "umask 002 && #{cmd}"
end

use_shards = File.file? 'shard.yml'

puts "installing shards"
if use_shards
  # update gem bundle
  run "shards install"
end

puts "building app"
run "crystal build /home/mixflame/livepost/src/livepost.cr"

if `pgrep -f livepost` != ""
  puts "killing off old server daemon"
  `pgrep -f livepost`.split("\n").each do |pid|
    run "kill #{pid}"
  end
end

puts "running livepost as a daemon"
run "nohup /home/mixflame/livepost/livepost &"